<html><head><title>Dashboard - ESP-ECU</title>
<meta name='viewport' content='width=device-width,initial-scale=1'>
<link rel='stylesheet' href='/theme.css'>
<script>document.documentElement.dataset.theme=localStorage.getItem('hp-theme')||'dark'</script>
<style>
body{font-family:Arial,sans-serif;margin:0;padding:0;background:var(--bg);}
nav{background:var(--nav-bg);padding:10px 20px;display:flex;align-items:center;gap:18px;}
nav a{color:#fff;text-decoration:none;font-size:14px;padding:6px 12px;border-radius:4px;}
nav a:hover,nav a.active{background:#4CAF50;}
nav .brand{font-weight:bold;font-size:16px;margin-right:auto;color:#fff;}
.content{max-width:1000px;margin:10px auto;padding:0 15px;}
.state-banner{text-align:center;padding:10px;border-radius:6px;font-size:20px;font-weight:bold;margin-bottom:12px;}
.state-OFF{background:#616161;color:#fff;}
.state-CRANKING{background:#ff9800;color:#fff;}
.state-RUNNING{background:#4CAF50;color:#fff;}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-bottom:12px;}
.card{background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:12px;}
.card h3{margin:0 0 8px;color:#4CAF50;font-size:13px;text-transform:uppercase;letter-spacing:0.5px;}
.gauge{text-align:center;padding:5px 0;}
.gauge .val{font-size:32px;font-weight:bold;color:var(--text);line-height:1.1;}
.gauge .unit{font-size:12px;color:var(--text-muted);}
.gauge .label{font-size:11px;color:var(--text-secondary);margin-top:2px;}
.row{display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--border-light);font-size:13px;}
.row:last-child{border-bottom:none;}
.row .lbl{color:var(--text-secondary);}
.row .val{font-weight:bold;color:var(--text);}
.trim-bar{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text-secondary);margin:2px 0;}
.trim-bar .bar-bg{flex:1;height:8px;background:var(--border);border-radius:4px;overflow:hidden;}
.trim-bar .bar-fill{height:100%;background:#4CAF50;border-radius:4px;transition:width 0.3s;}
.trim-bar .pct{width:35px;text-align:right;font-weight:bold;color:var(--text);}
.dual-gauge{display:flex;gap:15px;justify-content:center;}
.footer{text-align:center;color:var(--text-muted);font-size:11px;margin-top:8px;}
</style></head><body>
<nav><span class='brand'>ESP-ECU</span>
<a href='/'>Home</a>
<a href='/dashboard' class='active'>Dashboard</a>
<a href='/tune'>Tune</a>
<a href='/config'>Config</a>
<a href='/update'>Update</a>
<a href='/log/view'>Log</a>
<a href='/heap/view'>Heap</a>
<a href='#' onclick="if(confirm('Reboot device?')){fetch('/reboot',{method:'POST',headers:{'Authorization':'Basic '+btoa(prompt('user:pass','admin:'))}}).then(r=>r.ok?alert('Rebooting...'):alert('Failed'))};return false" style='margin-left:auto;background:#d32f2f;'>Reboot</a>
</nav>
<div class='content'>

<div class='state-banner state-OFF' id='banner'>OFF</div>

<div class='grid'>
<!-- RPM -->
<div class='card'>
<h3>RPM</h3>
<div class='gauge'><div class='val' id='rpm'>0</div><div class='unit'>RPM</div></div>
</div>

<!-- MAP -->
<div class='card'>
<h3>MAP</h3>
<div class='gauge'><div class='val' id='map'>0</div><div class='unit'>kPa</div></div>
</div>

<!-- TPS -->
<div class='card'>
<h3>TPS</h3>
<div class='gauge'><div class='val' id='tps'>0</div><div class='unit'>%</div></div>
</div>

<!-- AFR / CJ125 Wideband -->
<div class='card' id='afrCard'>
<h3 id='afrTitle'>AFR</h3>
<div id='afrContent'>
<div class='dual-gauge'>
<div class='gauge'><div class='val' id='afr1'>--</div><div class='label'>Bank 1</div></div>
<div class='gauge'><div class='val' id='afr2'>--</div><div class='label'>Bank 2</div></div>
</div>
</div>
</div>

<!-- Temps -->
<div class='card'>
<h3>Temperatures</h3>
<div class='row'><span class='lbl'>Coolant</span><span class='val' id='clt'>--</span></div>
<div class='row'><span class='lbl'>Intake Air</span><span class='val' id='iat'>--</span></div>
</div>

<!-- Ignition -->
<div class='card'>
<h3>Ignition</h3>
<div class='row'><span class='lbl'>Advance</span><span class='val' id='advance'>--</span></div>
<div class='row'><span class='lbl'>Rev Limit</span><span class='val' id='revLimiting'>--</span></div>
<div class='row'><span class='lbl'>Sync</span><span class='val' id='sync'>--</span></div>
</div>

<!-- Fuel -->
<div class='card'>
<h3>Fuel</h3>
<div class='row'><span class='lbl'>Pulse Width</span><span class='val' id='pw'>--</span></div>
<div class='row'><span class='lbl'>Target AFR</span><span class='val' id='targetAfr'>--</span></div>
<div class='row'><span class='lbl'>Fuel Cut</span><span class='val' id='fuelCut'>--</span></div>
</div>

<!-- Alternator -->
<div class='card'>
<h3>Alternator</h3>
<div class='row'><span class='lbl'>Battery</span><span class='val' id='vbat'>--</span></div>
<div class='row'><span class='lbl'>Field Duty</span><span class='val' id='altDuty'>--</span></div>
<div class='row'><span class='lbl'>Target</span><span class='val' id='altTarget'>--</span></div>
</div>

<!-- Per-cylinder trim -->
<div class='card' style='grid-column:span 2;'>
<h3>Injector Trim</h3>
<div id='trimBars'>--</div>
</div>

<!-- System -->
<div class='card'>
<h3>System</h3>
<div class='row'><span class='lbl'>CPU Core 0</span><span class='val' id='cpu0'>--</span></div>
<div class='row'><span class='lbl'>CPU Core 1</span><span class='val' id='cpu1'>--</span></div>
<div class='row'><span class='lbl'>Free Heap</span><span class='val' id='heap'>--</span></div>
<div class='row'><span class='lbl'>Sequential</span><span class='val' id='sequential'>--</span></div>
</div>

<!-- Transmission (hidden if not enabled) -->
<div class='card' id='transCard' style='display:none;grid-column:span 2;'>
<h3>Transmission</h3>
<div style='display:flex;gap:15px;flex-wrap:wrap;'>
<div style='flex:1;min-width:140px;'>
<div class='gauge'><div class='val' id='transGear' style='font-size:48px;'>P</div><div class='unit'>Gear</div></div>
</div>
<div style='flex:2;min-width:200px;'>
<div class='row'><span class='lbl'>MLPS</span><span class='val' id='transMlps'>--</span></div>
<div class='row'><span class='lbl'>OSS</span><span class='val' id='transOss'>--</span></div>
<div class='row'><span class='lbl'>TSS</span><span class='val' id='transTss'>--</span></div>
<div class='row'><span class='lbl'>Slip RPM</span><span class='val' id='transSlip'>--</span></div>
<div class='row'><span class='lbl'>TFT Temp</span><span class='val' id='transTft'>--</span></div>
<div class='row'><span class='lbl'>TCC Duty</span><span class='val' id='transTcc'>--</span></div>
<div class='row'><span class='lbl'>EPC Duty</span><span class='val' id='transEpc'>--</span></div>
<div class='row'><span class='lbl'>Solenoids</span><span class='val' id='transSol'>--</span></div>
<div class='row'><span class='lbl'>Status</span><span class='val' id='transStatus'>--</span></div>
</div>
</div>
</div>
</div>

<div class='footer' id='footer'></div>
</div>
<script>
function poll(){
  fetch('/state').then(function(r){return r.json();}).then(function(d){
    var st=d.state||'OFF';
    var banner=document.getElementById('banner');
    banner.textContent=st;
    banner.className='state-banner state-'+st;

    document.getElementById('rpm').textContent=d.rpm||0;
    document.getElementById('map').textContent=(d.mapKpa||0).toFixed(1);
    document.getElementById('tps').textContent=(d.tps||0).toFixed(1);

    // AFR / CJ125 Wideband O2
    var cj=d.cj125;
    if(cj&&cj.enabled){
      document.getElementById('afrTitle').textContent='CJ125 Wideband O2';
      document.getElementById('afrCard').style.gridColumn='span 2';
      var h='';
      for(var b=1;b<=2;b++){
        var bk=cj['bank'+b];
        if(!bk)continue;
        var st=bk.heaterState||'IDLE';
        var stColor=st==='PID'?'#4CAF50':st==='ERROR'?'#f44336':'#ff9800';
        var label=bk.ready?'Ready':(st==='PID'?'Ready':st);
        h+="<div style='flex:1;min-width:180px'>";
        h+="<div style='font-size:11px;color:var(--text-secondary);margin-bottom:4px'>Bank "+b+" <span style='color:"+stColor+";font-weight:bold'>"+label+"</span></div>";
        if(bk.ready){
          h+="<div class='row'><span class='lbl'>Lambda</span><span class='val'>"+bk.lambda.toFixed(3)+"</span></div>";
          h+="<div class='row'><span class='lbl'>AFR</span><span class='val'>"+bk.afr.toFixed(1)+"</span></div>";
          h+="<div class='row'><span class='lbl'>O2 %</span><span class='val'>"+bk.o2pct.toFixed(1)+"</span></div>";
        }else{
          h+="<div class='row'><span class='lbl'>Status</span><span class='val' style='color:"+stColor+"'>"+st+"</span></div>";
        }
        h+="<div class='row'><span class='lbl'>Heater</span><span class='val'>"+bk.heaterDuty.toFixed(0)+"%</span></div>";
        h+="</div>";
      }
      document.getElementById('afrContent').innerHTML="<div style='display:flex;gap:15px;flex-wrap:wrap'>"+h+"</div>";
    }else{
      document.getElementById('afrTitle').textContent='AFR';
      document.getElementById('afrCard').style.gridColumn='';
      var afr=d.afr||[0,0];
      document.getElementById('afrContent').innerHTML="<div class='dual-gauge'><div class='gauge'><div class='val'>"+(afr[0]?afr[0].toFixed(1):'--')+"</div><div class='label'>Bank 1</div></div><div class='gauge'><div class='val'>"+(afr[1]?afr[1].toFixed(1):'--')+"</div><div class='label'>Bank 2</div></div></div>";
    }

    document.getElementById('clt').textContent=(d.coolantTempF||0).toFixed(0)+' F';
    document.getElementById('iat').textContent=(d.iatTempF||0).toFixed(0)+' F';

    document.getElementById('advance').textContent=(d.sparkAdvanceDeg||0).toFixed(1)+' deg';
    document.getElementById('revLimiting').textContent=d.revLimiting?'ACTIVE':'--';
    document.getElementById('sync').textContent=d.syncState||'--';

    document.getElementById('pw').textContent=(d.injPulseWidthUs||0).toFixed(0)+' us';
    document.getElementById('targetAfr').textContent=(d.targetAfr||0).toFixed(1);
    document.getElementById('fuelCut').textContent=d.fuelCut?'YES':'No';

    document.getElementById('vbat').textContent=(d.batteryVoltage||0).toFixed(1)+' V';
    document.getElementById('altDuty').textContent=(d.altDuty||0).toFixed(1)+' %';
    document.getElementById('altTarget').textContent=(d.altTarget||0).toFixed(1)+' V';

    // Per-cylinder trim bars
    var trim=d.injTrim||[];
    var numCyl=d.numCylinders||8;
    var html='';
    for(var i=0;i<numCyl;i++){
      var t=trim[i]||1.0;
      var pct=Math.round(t*100);
      var w=Math.min(Math.max((pct-50)*2,0),100);
      html+="<div class='trim-bar'><span>#"+(i+1)+"</span><div class='bar-bg'><div class='bar-fill' style='width:"+w+"%'></div></div><span class='pct'>"+pct+"%</span></div>";
    }
    document.getElementById('trimBars').innerHTML=html;

    document.getElementById('cpu0').textContent=(d.cpuLoad0!==undefined?d.cpuLoad0+'%':'--');
    document.getElementById('cpu1').textContent=(d.cpuLoad1!==undefined?d.cpuLoad1+'%':'--');
    document.getElementById('heap').textContent=d.freeHeap?Math.round(d.freeHeap/1024)+' KB':'--';
    document.getElementById('sequential').textContent=d.sequential?'Yes':'No';

    // Transmission card
    var tr=d.transmission;
    if(tr&&tr.enabled){
      document.getElementById('transCard').style.display='';
      document.getElementById('transGear').textContent=tr.gear||'P';
      document.getElementById('transMlps').textContent=tr.mlps||'--';
      document.getElementById('transOss').textContent=(tr.ossRpm||0)+' RPM';
      document.getElementById('transTss').textContent=(tr.tssRpm||0)+' RPM';
      document.getElementById('transSlip').textContent=(tr.slipRpm||0)+' RPM';
      var tftEl=document.getElementById('transTft');
      tftEl.textContent=(tr.tftTempF||0).toFixed(0)+' F';
      tftEl.style.color=tr.overTemp?'#f44336':'';
      document.getElementById('transTcc').textContent=(tr.tccDuty||0).toFixed(0)+'%'+(tr.tccLocked?' LOCKED':'');
      document.getElementById('transEpc').textContent=(tr.epcDuty||0).toFixed(0)+'%';
      var sol='A:'+(tr.ssA?'ON':'off')+' B:'+(tr.ssB?'ON':'off');
      if(tr.ssC!==undefined)sol+=' C:'+(tr.ssC?'ON':'off');
      if(tr.ssD!==undefined)sol+=' D:'+(tr.ssD?'ON':'off');
      document.getElementById('transSol').textContent=sol;
      var status=[];
      if(tr.shifting)status.push('SHIFTING');
      if(tr.overTemp)status.push('OVER TEMP');
      if(tr.tccLocked)status.push('TCC LOCKED');
      document.getElementById('transStatus').textContent=status.length?status.join(', '):'Normal';
    }else{
      document.getElementById('transCard').style.display='none';
    }

    document.getElementById('footer').textContent='Updated: '+new Date().toLocaleTimeString();
  }).catch(function(){});
}
poll();setInterval(poll,1000);
fetch('/theme').then(function(r){return r.json()}).then(function(d){var t=d.theme||'light';document.documentElement.dataset.theme=t;localStorage.setItem('hp-theme',t);}).catch(function(){});
</script>
</body></html>
