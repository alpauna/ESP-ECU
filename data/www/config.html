<html><head><title>Config - ESP-ECU</title>
<meta name='viewport' content='width=device-width,initial-scale=1'>
<link rel='stylesheet' href='/theme.css'>
<script>document.documentElement.dataset.theme=localStorage.getItem('hp-theme')||'dark'</script>
<style>
body{font-family:Arial,sans-serif;margin:0;padding:0;background:var(--bg);}
nav{background:var(--nav-bg);padding:10px 20px;display:flex;align-items:center;gap:18px;}
nav a{color:#fff;text-decoration:none;font-size:14px;padding:6px 12px;border-radius:4px;}
nav a:hover,nav a.active{background:#4CAF50;}
nav .brand{font-weight:bold;font-size:16px;margin-right:auto;color:#fff;}
.content{max-width:700px;margin:20px auto;padding:0 20px;}
h1{color:var(--text);}
fieldset{border:1px solid var(--border);border-radius:6px;padding:15px;margin-bottom:15px;background:var(--surface);}
legend{color:#4CAF50;font-weight:bold;padding:0 8px;font-size:14px;}
label{display:block;margin:8px 0 3px;color:var(--text-secondary);font-size:13px;}
input[type=text],input[type=number],input[type=password],select{width:100%;padding:7px;border:1px solid var(--input-border);border-radius:4px;box-sizing:border-box;background:var(--input-bg);color:var(--text);font-size:13px;}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
button{background:#4CAF50;color:#fff;padding:8px 24px;border:none;border-radius:4px;cursor:pointer;font-size:14px;margin-top:10px;}
button:hover{background:#45a049;}
.btn-ftp{background:#2196F3;}.btn-ftp:hover{background:#1976D2;}
.btn-ftp-off{background:#f44336;}.btn-ftp-off:hover{background:#d32f2f;}
#status{margin-top:15px;padding:10px;border-radius:4px;display:none;font-size:14px;}
.ok{background:#d4edda;color:#155724;display:block!important;}
.err{background:#f8d7da;color:#721c24;display:block!important;}
.ftp-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px;}
.ftp-status{font-size:13px;color:var(--text-secondary);}
</style></head><body>
<nav><span class='brand'>ESP-ECU</span>
<button class='hamburger' onclick='this.nextElementSibling.classList.toggle("open")'><span></span><span></span><span></span></button>
<div class='nav-links'>
<a href='/'>Home</a>
<a href='/dashboard'>Dashboard</a>
<a href='/tune'>Tune</a>
<a href='/pins'>Pins</a>
<a href='/config' class='active'>Config</a>
<a href='/update'>Update</a>
<a href='/log/view'>Log</a>
<a href='/heap/view'>Heap</a>
<a href='#' class='reboot' onclick="if(confirm('Reboot device?')){fetch('/reboot',{method:'POST',headers:{'Authorization':'Basic '+btoa(prompt('user:pass','admin:'))}}).then(r=>r.ok?alert('Rebooting...'):alert('Failed'))};return false">Reboot</a>
</div></nav>
<div class='content'>
<div id='safeBanner' style='display:none;background:#d32f2f;color:#fff;padding:12px 16px;border-radius:6px;margin-bottom:15px;font-size:14px;'>
<strong>SAFE MODE ACTIVE</strong> â€” Peripherals disabled. <span id='safeBannerInfo'></span>
<button type='button' onclick='clearSafeMode()' style='background:#fff;color:#d32f2f;border:none;padding:6px 16px;border-radius:4px;cursor:pointer;font-weight:bold;margin-left:10px;'>Clear &amp; Reboot</button>
</div>
<h1>Configuration</h1>
<form id='configForm' onsubmit='return save(event)'>

<fieldset><legend>Engine</legend>
<label>Engine Preset</label>
<select id='enginePreset' onchange='applyEnginePreset()'>
<option value=''>Custom</option>
</select>
<div class='row2'>
<div><label>Cylinders</label><input type='number' id='cylinders' min='1' max='12'></div>
<div><label>Displacement (cc)</label><input type='number' id='displacement'></div>
</div>
<label>Firing Order (comma separated)</label>
<input type='text' id='firingOrder' placeholder='1,8,4,3,6,5,7,2'>
<div class='row2'>
<div><label>Crank Teeth</label><input type='number' id='crankTeeth'></div>
<div><label>Missing Teeth</label><input type='number' id='crankMissing'></div>
</div>
<label>Cam Sensor</label>
<select id='hasCamSensor'><option value='true'>Present</option><option value='false'>Not Present</option></select>
<div class='row2'>
<div><label>Rev Limit (RPM)</label><input type='number' id='revLimitRpm'></div>
<div><label>Max Dwell (ms)</label><input type='number' id='maxDwellMs' step='0.1'></div>
</div>
<div class='row2'>
<div><label>Injector Flow (cc/min)</label><input type='number' id='injectorFlowCcMin' step='1'></div>
<div><label>Injector Dead Time (ms)</label><input type='number' id='injectorDeadTimeMs' step='0.1'></div>
</div>
<label style='margin-top:10px'><input type='checkbox' id='cj125Enabled' style='width:auto;margin-right:6px'>CJ125 Wideband O2 Controller (requires reboot)</label>
</fieldset>

<fieldset><legend>Alternator</legend>
<div class='row2'>
<div><label>Target Voltage (V)</label><input type='number' id='altTargetVoltage' step='0.1'></div>
<div><label>PID P</label><input type='number' id='altPidP' step='0.1'></div>
</div>
<div class='row2'>
<div><label>PID I</label><input type='number' id='altPidI' step='0.1'></div>
<div><label>PID D</label><input type='number' id='altPidD' step='0.1'></div>
</div>
</fieldset>

<fieldset><legend>MAP Sensor</legend>
<div class='row2'>
<div><label>Voltage Min (V)</label><input type='number' id='mapVoltageMin' step='0.01'></div>
<div><label>Voltage Max (V)</label><input type='number' id='mapVoltageMax' step='0.01'></div>
</div>
<div class='row2'>
<div><label>Pressure Min (kPa)</label><input type='number' id='mapPressureMinKpa' step='1'></div>
<div><label>Pressure Max (kPa)</label><input type='number' id='mapPressureMaxKpa' step='1'></div>
</div>
</fieldset>

<fieldset><legend>O2 Sensors</legend>
<div class='row2'>
<div><label>AFR at 0V</label><input type='number' id='o2AfrAt0v' step='0.1'></div>
<div><label>AFR at 5V</label><input type='number' id='o2AfrAt5v' step='0.1'></div>
</div>
<div class='row2'>
<div><label>Closed Loop Min RPM</label><input type='number' id='closedLoopMinRpm'></div>
<div><label>Closed Loop Max RPM</label><input type='number' id='closedLoopMaxRpm'></div>
</div>
<label>Closed Loop Max MAP (kPa)</label>
<input type='number' id='closedLoopMaxMapKpa' step='1'>
</fieldset>

<fieldset><legend>Transmission</legend>
<label>Transmission Preset</label>
<select id='transPreset' onchange='applyTransPreset()'>
<option value=''>None</option>
</select>
<label>Type (requires reboot)</label>
<select id='transType' onchange='toggleTransFields()'>
<option value='0'>None</option>
</select>
<div id='transFields' style='display:none'>
<div class='row2'>
<div><label>Upshift 1-2 RPM</label><input type='number' id='upshift12Rpm'></div>
<div><label>Upshift 2-3 RPM</label><input type='number' id='upshift23Rpm'></div>
</div>
<div class='row2'>
<div><label>Upshift 3-4 RPM</label><input type='number' id='upshift34Rpm'></div>
<div><label>Downshift 2-1 RPM</label><input type='number' id='downshift21Rpm'></div>
</div>
<div class='row2'>
<div><label>Downshift 3-2 RPM</label><input type='number' id='downshift32Rpm'></div>
<div><label>Downshift 4-3 RPM</label><input type='number' id='downshift43Rpm'></div>
</div>
<div class='row2'>
<div><label>TCC Lock RPM</label><input type='number' id='tccLockRpm'></div>
<div><label>TCC Lock Gear</label><input type='number' id='tccLockGear' min='1' max='4'></div>
</div>
<div class='row2'>
<div><label>TCC Apply Rate (%/100ms)</label><input type='number' id='tccApplyRate' step='0.5'></div>
<div><label>Shift Time (ms)</label><input type='number' id='shiftTimeMs'></div>
</div>
<div class='row2'>
<div><label>EPC Base Duty (%)</label><input type='number' id='epcBaseDuty' step='1'></div>
<div><label>EPC Shift Boost (%)</label><input type='number' id='epcShiftBoost' step='1'></div>
</div>
<label>Max TFT Temp (F)</label><input type='number' id='maxTftTempF' step='5'>
</div>
</fieldset>

<fieldset><legend>Pin Map</legend>
<label>Board Preset</label>
<select id='pinPreset' onchange='applyPinPreset()'>
<option value=''>Custom</option>
</select>
<div id='pinDupWarn' style='display:none;color:#f44336;font-size:13px;margin:8px 0;padding:6px;background:#ffebee;border-radius:4px'></div>
<p style='font-size:12px;color:var(--text-secondary);margin:4px 0 12px'>Locked: CRANK=GPIO1, CAM=GPIO2, SD=47/48/38/39. Pin changes require reboot.</p>
<label style='font-weight:bold;color:var(--text);font-size:13px;margin-bottom:4px'>Analog Inputs (ADC1)</label>
<div class='row2'>
<div><label>O2 Bank 1</label><select id='pinO2Bank1' class='pinSel' onchange='checkPinDups()'></select></div>
<div><label>O2 Bank 2</label><select id='pinO2Bank2' class='pinSel' onchange='checkPinDups()'></select></div>
</div>
<div class='row2'>
<div><label>MAP</label><select id='pinMap' class='pinSel' onchange='checkPinDups()'></select></div>
<div><label>TPS</label><select id='pinTps' class='pinSel' onchange='checkPinDups()'></select></div>
</div>
<div class='row2'>
<div><label>CLT</label><select id='pinClt' class='pinSel' onchange='checkPinDups()'></select></div>
<div><label>IAT</label><select id='pinIat' class='pinSel' onchange='checkPinDups()'></select></div>
</div>
<div><label>VBAT</label><select id='pinVbat' class='pinSel' onchange='checkPinDups()'></select></div>
<label style='font-weight:bold;color:var(--text);font-size:13px;margin:12px 0 4px'>PWM Outputs</label>
<div class='row2'>
<div><label>Alternator</label><select id='pinAlternator' class='pinSel' onchange='checkPinDups()'></select></div>
<div><label>Heater 1 (CJ125)</label><select id='pinHeater1' class='pinSel' onchange='checkPinDups()'></select></div>
</div>
<div class='row2'>
<div><label>Heater 2 (CJ125)</label><select id='pinHeater2' class='pinSel' onchange='checkPinDups()'></select></div>
<div><label>TCC PWM</label><select id='pinTcc' class='pinSel' onchange='checkPinDups()'></select></div>
</div>
<div><label>EPC PWM</label><select id='pinEpc' class='pinSel' onchange='checkPinDups()'></select></div>
<label style='font-weight:bold;color:var(--text);font-size:13px;margin:12px 0 4px'>HSPI Bus</label>
<div class='row2'>
<div><label>SCK</label><select id='pinHspiSck' class='pinSel' onchange='checkPinDups()'></select></div>
<div><label>MOSI</label><select id='pinHspiMosi' class='pinSel' onchange='checkPinDups()'></select></div>
</div>
<div class='row2'>
<div><label>MISO</label><select id='pinHspiMiso' class='pinSel' onchange='checkPinDups()'></select></div>
<div><label>CS Coils</label><select id='pinHspiCsCoils' class='pinSel' onchange='checkPinDups()'></select></div>
</div>
<div><label>CS Injectors</label><select id='pinHspiCsInj' class='pinSel' onchange='checkPinDups()'></select></div>
<label style='font-weight:bold;color:var(--text);font-size:13px;margin:12px 0 4px'>I2C Bus</label>
<div class='row2'>
<div><label>SDA</label><select id='pinI2cSda' class='pinSel' onchange='checkPinDups()'></select></div>
<div><label>SCL</label><select id='pinI2cScl' class='pinSel' onchange='checkPinDups()'></select></div>
</div>
</fieldset>

<fieldset><legend>Peripherals &amp; Safe Mode</legend>
<label style='margin-top:2px'><input type='checkbox' id='forceSafeMode' style='width:auto;margin-right:6px'>Force safe mode on next reboot</label>
<label style='font-weight:bold;color:var(--text);font-size:13px;margin:10px 0 4px'>Bus Control (requires reboot)</label>
<label><input type='checkbox' id='i2cEnabled' style='width:auto;margin-right:6px' onchange='togglePeriphDeps()'>I2C Bus (MCP23017 + ADS1115)</label>
<label><input type='checkbox' id='spiExpandersEnabled' style='width:auto;margin-right:6px' onchange='togglePeriphDeps()'>SPI Expanders (MCP23S17 HSPI)</label>
<label style='font-weight:bold;color:var(--text);font-size:13px;margin:10px 0 4px'>I2C Expanders</label>
<div class='row2'>
<div><label><input type='checkbox' id='expander0Enabled' class='i2cDep' style='width:auto;margin-right:6px'>MCP23017 #0 @ 0x20 (fuel, tach, CEL, CJ125 CS)</label></div>
<div><label><input type='checkbox' id='expander1Enabled' class='i2cDep' style='width:auto;margin-right:6px'>MCP23017 #1 @ 0x21 (transmission)</label></div>
</div>
<div class='row2'>
<div><label><input type='checkbox' id='expander2Enabled' class='i2cDep' style='width:auto;margin-right:6px'>MCP23017 #2 @ 0x22 (spare)</label></div>
<div><label><input type='checkbox' id='expander3Enabled' class='i2cDep' style='width:auto;margin-right:6px'>MCP23017 #3 @ 0x23 (spare)</label></div>
</div>
<label style='font-weight:bold;color:var(--text);font-size:13px;margin:10px 0 4px'>SPI Expanders</label>
<div class='row2'>
<div><label><input type='checkbox' id='spiExp0Enabled' class='spiDep' style='width:auto;margin-right:6px'>MCP23S17 #0 (coils)</label></div>
<div><label><input type='checkbox' id='spiExp1Enabled' class='spiDep' style='width:auto;margin-right:6px'>MCP23S17 #1 (injectors)</label></div>
</div>
</fieldset>

<fieldset><legend>WiFi</legend>
<label>SSID</label><input type='text' id='wifiSSID'>
<label>Password</label><input type='password' id='wifiPassword' placeholder='Leave blank to keep current'>
<label>AP Fallback Timeout (minutes)</label><input type='number' id='apFallbackMin' min='1'>
<a href='/wifi/view' style='font-size:13px;color:#2196F3;'>WiFi Setup Page</a>
</fieldset>

<fieldset><legend>MQTT</legend>
<div class='row2'>
<div><label>Host</label><input type='text' id='mqttHost'></div>
<div><label>Port</label><input type='number' id='mqttPort'></div>
</div>
<div class='row2'>
<div><label>User</label><input type='text' id='mqttUser'></div>
<div><label>Password</label><input type='password' id='mqttPassword' placeholder='Leave blank to keep current'></div>
</div>
</fieldset>

<fieldset><legend>Appearance</legend>
<label>Theme</label>
<select id='theme'><option value='light'>Light</option><option value='dark'>Dark</option></select>
</fieldset>

<fieldset><legend>Admin</legend>
<label>New Admin Password</label>
<input type='password' id='adminPassword' placeholder='Leave blank to keep current'>
</fieldset>

<fieldset><legend>FTP Server</legend>
<div class='ftp-row'>
<button type='button' class='btn-ftp' onclick='ftpEnable(10)'>Enable 10m</button>
<button type='button' class='btn-ftp' onclick='ftpEnable(30)'>Enable 30m</button>
<button type='button' class='btn-ftp' onclick='ftpEnable(60)'>Enable 60m</button>
<button type='button' class='btn-ftp-off' onclick='ftpDisable()'>Disable</button>
</div>
<div class='ftp-status' id='ftpStatus'>Checking...</div>
</fieldset>

<button type='submit'>Save Configuration</button>
</form>
<div id='status'></div>
</div>
<script>
var _enginePresets={};
var _transPresets={};
var _pinPresets={};
var _prevTransType='0';
var _adcPins=[3,4,5,6,7,8,9,10];
var _reservedPins=[1,2,33,34,35,36,37,38,39,47,48];
var _allGpio=[];
(function(){for(var i=0;i<=48;i++){if(_reservedPins.indexOf(i)<0)_allGpio.push(i);}})();
var _pinFields=['pinO2Bank1','pinO2Bank2','pinMap','pinTps','pinClt','pinIat','pinVbat',
  'pinAlternator','pinHeater1','pinHeater2','pinTcc','pinEpc',
  'pinHspiSck','pinHspiMosi','pinHspiMiso','pinHspiCsCoils','pinHspiCsInj','pinI2cSda','pinI2cScl'];
var _adcFields=['pinO2Bank1','pinO2Bank2','pinMap','pinTps','pinClt','pinIat','pinVbat'];

function populatePinSelects(){
  _pinFields.forEach(function(id){
    var sel=document.getElementById(id);if(!sel)return;
    var pins=(_adcFields.indexOf(id)>=0)?_adcPins:_allGpio;
    sel.innerHTML='';
    pins.forEach(function(p){var o=document.createElement('option');o.value=p;o.textContent='GPIO '+p;sel.appendChild(o);});
  });
}

function load(){
  populatePinSelects();
  Promise.all([
    fetch('/presets/engines').then(function(r){return r.json()}).catch(function(){return {}}),
    fetch('/presets/transmissions').then(function(r){return r.json()}).catch(function(){return {}}),
    fetch('/presets/pins').then(function(r){return r.json()}).catch(function(){return {}}),
    fetch('/config?format=json').then(function(r){return r.json()})
  ]).then(function(results){
    _enginePresets=results[0];
    _transPresets=results[1];
    _pinPresets=results[2];
    var d=results[3];

    // Populate engine preset dropdown
    var ep=document.getElementById('enginePreset');
    for(var name in _enginePresets){
      var o=document.createElement('option');o.value=name;o.textContent=name;ep.appendChild(o);
    }

    // Populate transmission preset dropdown and transType options
    var tp=document.getElementById('transPreset');
    var tt=document.getElementById('transType');
    for(var name in _transPresets){
      var o=document.createElement('option');o.value=name;o.textContent=name;tp.appendChild(o);
      var to=document.createElement('option');to.value=_transPresets[name].transType;to.textContent=name;tt.appendChild(to);
    }

    // Fill form fields from current config
    document.getElementById('cylinders').value=d.cylinders||8;
    document.getElementById('displacement').value=d.displacement||5700;
    document.getElementById('firingOrder').value=(d.firingOrder||[]).join(',');
    document.getElementById('crankTeeth').value=d.crankTeeth||36;
    document.getElementById('crankMissing').value=d.crankMissing||1;
    document.getElementById('hasCamSensor').value=d.hasCamSensor?'true':'false';
    document.getElementById('revLimitRpm').value=d.revLimitRpm||6000;
    document.getElementById('maxDwellMs').value=d.maxDwellMs||4.0;
    document.getElementById('injectorFlowCcMin').value=d.injectorFlowCcMin||240;
    document.getElementById('injectorDeadTimeMs').value=d.injectorDeadTimeMs||1.0;
    document.getElementById('cj125Enabled').checked=d.cj125Enabled||false;
    document.getElementById('altTargetVoltage').value=d.altTargetVoltage||13.6;
    document.getElementById('altPidP').value=d.altPidP||10;
    document.getElementById('altPidI').value=d.altPidI||5;
    document.getElementById('altPidD').value=d.altPidD||0;
    document.getElementById('mapVoltageMin').value=d.mapVoltageMin||0.5;
    document.getElementById('mapVoltageMax').value=d.mapVoltageMax||4.5;
    document.getElementById('mapPressureMinKpa').value=d.mapPressureMinKpa||10;
    document.getElementById('mapPressureMaxKpa').value=d.mapPressureMaxKpa||105;
    document.getElementById('o2AfrAt0v').value=d.o2AfrAt0v||10;
    document.getElementById('o2AfrAt5v').value=d.o2AfrAt5v||20;
    document.getElementById('closedLoopMinRpm').value=d.closedLoopMinRpm||800;
    document.getElementById('closedLoopMaxRpm').value=d.closedLoopMaxRpm||4000;
    document.getElementById('closedLoopMaxMapKpa').value=d.closedLoopMaxMapKpa||80;
    var tv=String(d.transType||0);
    document.getElementById('transType').value=tv;
    _prevTransType=tv;
    document.getElementById('upshift12Rpm').value=d.upshift12Rpm||1500;
    document.getElementById('upshift23Rpm').value=d.upshift23Rpm||2500;
    document.getElementById('upshift34Rpm').value=d.upshift34Rpm||3000;
    document.getElementById('downshift21Rpm').value=d.downshift21Rpm||1200;
    document.getElementById('downshift32Rpm').value=d.downshift32Rpm||1800;
    document.getElementById('downshift43Rpm').value=d.downshift43Rpm||2200;
    document.getElementById('tccLockRpm').value=d.tccLockRpm||1500;
    document.getElementById('tccLockGear').value=d.tccLockGear||3;
    document.getElementById('tccApplyRate').value=d.tccApplyRate||5.0;
    document.getElementById('epcBaseDuty').value=d.epcBaseDuty||50;
    document.getElementById('epcShiftBoost').value=d.epcShiftBoost||80;
    document.getElementById('shiftTimeMs').value=d.shiftTimeMs||500;
    document.getElementById('maxTftTempF').value=d.maxTftTempF||275;
    toggleTransFields();

    // Populate pin preset dropdown
    var pp=document.getElementById('pinPreset');
    for(var name in _pinPresets){
      var o=document.createElement('option');o.value=name;o.textContent=name;pp.appendChild(o);
    }
    // Fill pin values from config
    _pinFields.forEach(function(id){
      var el=document.getElementById(id);
      if(el&&d[id]!==undefined)el.value=d[id];
    });
    matchPinPreset();
    checkPinDups();

    // Peripherals & Safe Mode
    document.getElementById('forceSafeMode').checked=d.forceSafeMode||false;
    document.getElementById('i2cEnabled').checked=d.i2cEnabled!==false;
    document.getElementById('spiExpandersEnabled').checked=d.spiExpandersEnabled!==false;
    document.getElementById('expander0Enabled').checked=d.expander0Enabled!==false;
    document.getElementById('expander1Enabled').checked=d.expander1Enabled!==false;
    document.getElementById('expander2Enabled').checked=d.expander2Enabled!==false;
    document.getElementById('expander3Enabled').checked=d.expander3Enabled!==false;
    document.getElementById('spiExp0Enabled').checked=d.spiExp0Enabled!==false;
    document.getElementById('spiExp1Enabled').checked=d.spiExp1Enabled!==false;
    togglePeriphDeps();
    if(d.safeMode){
      document.getElementById('safeBanner').style.display='block';
      document.getElementById('safeBannerInfo').textContent='Boot count: '+(d.bootCount||'?')+', last reset: '+(d.resetReason||'?');
    }

    document.getElementById('wifiSSID').value=d.wifiSSID||'';
    document.getElementById('apFallbackMin').value=d.apFallbackMinutes||10;
    document.getElementById('mqttHost').value=d.mqttHost||'';
    document.getElementById('mqttPort').value=d.mqttPort||1883;
    document.getElementById('mqttUser').value=d.mqttUser||'';
    document.getElementById('theme').value=d.theme||'dark';

    // Try to match current config against engine presets
    matchEnginePreset();
    matchTransPreset();
  }).catch(function(){});
}

function togglePeriphDeps(){
  var i2c=document.getElementById('i2cEnabled').checked;
  var spi=document.getElementById('spiExpandersEnabled').checked;
  var deps=document.querySelectorAll('.i2cDep');
  for(var x=0;x<deps.length;x++){deps[x].disabled=!i2c;if(!i2c)deps[x].style.opacity='0.5';else deps[x].style.opacity='1';}
  var sdeps=document.querySelectorAll('.spiDep');
  for(var x=0;x<sdeps.length;x++){sdeps[x].disabled=!spi;if(!spi)sdeps[x].style.opacity='0.5';else sdeps[x].style.opacity='1';}
}

function clearSafeMode(){
  if(!confirm('Clear safe mode and reboot?'))return;
  fetch('/safemode/clear',{method:'POST',headers:{'Content-Type':'application/json'}}).then(function(r){return r.json()}).then(function(d){
    alert(d.message||'Rebooting...');
  }).catch(function(e){alert('Error: '+e);});
}

function matchEnginePreset(){
  var ep=document.getElementById('enginePreset');
  var keys=['cylinders','displacement','crankTeeth','crankMissing','revLimitRpm'];
  for(var name in _enginePresets){
    var p=_enginePresets[name];var match=true;
    for(var i=0;i<keys.length;i++){
      var el=document.getElementById(keys[i]);
      if(el&&String(el.value)!==String(p[keys[i]])){match=false;break;}
    }
    if(match){
      var fo=document.getElementById('firingOrder').value;
      if(fo!==(p.firingOrder||[]).join(',')){match=false;}
    }
    if(match){ep.value=name;return;}
  }
  ep.value='';
}

function matchTransPreset(){
  var tp=document.getElementById('transPreset');
  var tt=document.getElementById('transType').value;
  if(tt==='0'){tp.value='';return;}
  var keys=['upshift12Rpm','upshift23Rpm','upshift34Rpm','downshift21Rpm','downshift32Rpm','downshift43Rpm','tccLockRpm','tccLockGear','tccApplyRate','epcBaseDuty','epcShiftBoost','shiftTimeMs','maxTftTempF'];
  for(var name in _transPresets){
    var p=_transPresets[name];
    if(String(p.transType)!==tt)continue;
    var match=true;
    for(var i=0;i<keys.length;i++){
      var el=document.getElementById(keys[i]);
      if(el&&String(el.value)!==String(p[keys[i]])){match=false;break;}
    }
    if(match){tp.value=name;return;}
  }
  tp.value='';
}

function applyEnginePreset(){
  var name=document.getElementById('enginePreset').value;
  if(!name||!_enginePresets[name])return;
  var p=_enginePresets[name];
  for(var k in p){
    if(k==='firingOrder'){
      document.getElementById('firingOrder').value=(p[k]||[]).join(',');
    } else if(k==='hasCamSensor'){
      document.getElementById('hasCamSensor').value=p[k]?'true':'false';
    } else {
      var el=document.getElementById(k);
      if(el)el.value=p[k];
    }
  }
}

function applyTransPreset(){
  var name=document.getElementById('transPreset').value;
  if(!name||!_transPresets[name]){
    document.getElementById('transType').value='0';
    toggleTransFields();
    return;
  }
  var p=_transPresets[name];
  for(var k in p){
    var el=document.getElementById(k);
    if(el)el.value=p[k];
  }
  toggleTransFields();
}

function toggleTransFields(){
  var v=document.getElementById('transType').value;
  document.getElementById('transFields').style.display=v!=='0'?'block':'none';
  _prevTransType=v;
}

function matchPinPreset(){
  var pp=document.getElementById('pinPreset');
  for(var name in _pinPresets){
    var p=_pinPresets[name];var match=true;
    for(var i=0;i<_pinFields.length;i++){
      var el=document.getElementById(_pinFields[i]);
      if(el&&String(el.value)!==String(p[_pinFields[i]])){match=false;break;}
    }
    if(match){pp.value=name;return;}
  }
  pp.value='';
}

function applyPinPreset(){
  var name=document.getElementById('pinPreset').value;
  if(!name||!_pinPresets[name])return;
  var p=_pinPresets[name];
  _pinFields.forEach(function(id){
    var el=document.getElementById(id);
    if(el&&p[id]!==undefined)el.value=p[id];
  });
  checkPinDups();
}

function checkPinDups(){
  var used={};var dups=[];
  _pinFields.forEach(function(id){
    var el=document.getElementById(id);if(!el)return;
    var v=el.value;
    el.style.borderColor='';
    if(used[v]){dups.push(id+' and '+used[v]+' both use GPIO '+v);el.style.borderColor='#f44336';
      document.getElementById(used[v]).style.borderColor='#f44336';
    }
    used[v]=id;
  });
  var w=document.getElementById('pinDupWarn');
  if(dups.length){w.style.display='block';w.textContent='Duplicate pins: '+dups.join('; ');}
  else{w.style.display='none';}
}

function save(e){
  e.preventDefault();
  var fo=document.getElementById('firingOrder').value.split(',').map(Number);
  var data={
    cylinders:parseInt(document.getElementById('cylinders').value),
    displacement:parseInt(document.getElementById('displacement').value),
    firingOrder:fo,
    crankTeeth:parseInt(document.getElementById('crankTeeth').value),
    crankMissing:parseInt(document.getElementById('crankMissing').value),
    hasCamSensor:document.getElementById('hasCamSensor').value==='true',
    revLimitRpm:parseInt(document.getElementById('revLimitRpm').value),
    maxDwellMs:parseFloat(document.getElementById('maxDwellMs').value),
    injectorFlowCcMin:parseFloat(document.getElementById('injectorFlowCcMin').value),
    injectorDeadTimeMs:parseFloat(document.getElementById('injectorDeadTimeMs').value),
    cj125Enabled:document.getElementById('cj125Enabled').checked,
    altTargetVoltage:parseFloat(document.getElementById('altTargetVoltage').value),
    altPidP:parseFloat(document.getElementById('altPidP').value),
    altPidI:parseFloat(document.getElementById('altPidI').value),
    altPidD:parseFloat(document.getElementById('altPidD').value),
    mapVoltageMin:parseFloat(document.getElementById('mapVoltageMin').value),
    mapVoltageMax:parseFloat(document.getElementById('mapVoltageMax').value),
    mapPressureMinKpa:parseFloat(document.getElementById('mapPressureMinKpa').value),
    mapPressureMaxKpa:parseFloat(document.getElementById('mapPressureMaxKpa').value),
    o2AfrAt0v:parseFloat(document.getElementById('o2AfrAt0v').value),
    o2AfrAt5v:parseFloat(document.getElementById('o2AfrAt5v').value),
    closedLoopMinRpm:parseInt(document.getElementById('closedLoopMinRpm').value),
    closedLoopMaxRpm:parseInt(document.getElementById('closedLoopMaxRpm').value),
    closedLoopMaxMapKpa:parseFloat(document.getElementById('closedLoopMaxMapKpa').value),
    transType:parseInt(document.getElementById('transType').value),
    upshift12Rpm:parseInt(document.getElementById('upshift12Rpm').value),
    upshift23Rpm:parseInt(document.getElementById('upshift23Rpm').value),
    upshift34Rpm:parseInt(document.getElementById('upshift34Rpm').value),
    downshift21Rpm:parseInt(document.getElementById('downshift21Rpm').value),
    downshift32Rpm:parseInt(document.getElementById('downshift32Rpm').value),
    downshift43Rpm:parseInt(document.getElementById('downshift43Rpm').value),
    tccLockRpm:parseInt(document.getElementById('tccLockRpm').value),
    tccLockGear:parseInt(document.getElementById('tccLockGear').value),
    tccApplyRate:parseFloat(document.getElementById('tccApplyRate').value),
    epcBaseDuty:parseFloat(document.getElementById('epcBaseDuty').value),
    epcShiftBoost:parseFloat(document.getElementById('epcShiftBoost').value),
    shiftTimeMs:parseInt(document.getElementById('shiftTimeMs').value),
    maxTftTempF:parseFloat(document.getElementById('maxTftTempF').value),
    wifiSSID:document.getElementById('wifiSSID').value,
    apFallbackMinutes:parseInt(document.getElementById('apFallbackMin').value),
    mqttHost:document.getElementById('mqttHost').value,
    mqttPort:parseInt(document.getElementById('mqttPort').value),
    mqttUser:document.getElementById('mqttUser').value,
    theme:document.getElementById('theme').value,
    forceSafeMode:document.getElementById('forceSafeMode').checked,
    i2cEnabled:document.getElementById('i2cEnabled').checked,
    spiExpandersEnabled:document.getElementById('spiExpandersEnabled').checked,
    expander0Enabled:document.getElementById('expander0Enabled').checked,
    expander1Enabled:document.getElementById('expander1Enabled').checked,
    expander2Enabled:document.getElementById('expander2Enabled').checked,
    expander3Enabled:document.getElementById('expander3Enabled').checked,
    spiExp0Enabled:document.getElementById('spiExp0Enabled').checked,
    spiExp1Enabled:document.getElementById('spiExp1Enabled').checked
  };
  _pinFields.forEach(function(id){data[id]=parseInt(document.getElementById(id).value);});
  var pw=document.getElementById('wifiPassword').value;if(pw) data.wifiPassword=pw;
  var mpw=document.getElementById('mqttPassword').value;if(mpw) data.mqttPassword=mpw;
  var apw=document.getElementById('adminPassword').value;if(apw) data.adminPassword=apw;

  var s=document.getElementById('status');
  fetch('/config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)}).then(function(r){return r.json();}).then(function(d){
    if(d.error){s.className='err';s.textContent=d.error;}
    else{s.className='ok';s.textContent=d.message||'Configuration saved.';
      var t=data.theme;document.documentElement.dataset.theme=t;localStorage.setItem('hp-theme',t);
    }
  }).catch(function(err){s.className='err';s.textContent='Error: '+err;});
  return false;
}

function ftpEnable(min){fetch('/ftp',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'enable',duration:min})}).then(function(){checkFtp();});}
function ftpDisable(){fetch('/ftp',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'disable'})}).then(function(){checkFtp();});}
function checkFtp(){fetch('/ftp').then(function(r){return r.json();}).then(function(d){document.getElementById('ftpStatus').textContent=d.active?'Active ('+d.remainingMinutes+' min remaining)':'Inactive';}).catch(function(){document.getElementById('ftpStatus').textContent='Unknown';});}

load();checkFtp();
fetch('/theme').then(function(r){return r.json()}).then(function(d){var t=d.theme||'light';document.documentElement.dataset.theme=t;localStorage.setItem('hp-theme',t);}).catch(function(){});
</script>
</body></html>
